# Teiko technical: Immune Cell Population Analysis

An interactive clinical trial data analysis tool built with Python, SQLite, and Streamlit.

---

## Running in GitHub Codespaces

> All commands below work out of the box in a fresh GitHub Codespace.

### 1. Install dependencies

```bash
pip install -r requirements.txt
```

### 2. Initialize the database

```bash
python load_data.py
```

This loads `cell-count.csv` into a SQLite database (`teiko.db`) in the repo root. Output:

```
Initializing schema...
Loading data from cell-count.csv...
Done. Loaded into teiko.db:
  3 project(s)
  3500 subject(s)
  10500 sample(s)
```

### 3. Launch the dashboard (or just view it from the link below)

```bash
streamlit run dashboard.py
```

Streamlit will print a local URL (e.g. `http://localhost:8501`). In Codespaces, the port will be automatically forwarded and accessible via the **Ports** tab.

---

## Dashboard Link

[Launch Dashboard](https://zmt-cytometry.streamlit.app/)

---

## Database Schema

### Tables

#### `projects`
| Column | Type | Notes |
|--------|------|-------|
| `project_id` | TEXT | Primary key |

#### `subjects`
| Column | Type | Notes |
|--------|------|-------|
| `subject_id` | TEXT | Primary key |
| `project_id` | TEXT | Foreign key → `projects` |
| `condition` | TEXT | e.g. melanoma, carcinoma, healthy |
| `age` | INTEGER | |
| `sex` | TEXT | M / F |

#### `samples`
| Column | Type | Notes |
|--------|------|-------|
| `sample_id` | TEXT | Primary key |
| `subject_id` | TEXT | Foreign key → `subjects` |
| `sample_type` | TEXT | e.g. PBMC |
| `time_from_treatment_start` | INTEGER | Days since treatment start |
| `treatment` | TEXT | e.g. miraclib, phauximab, none |
| `response` | TEXT | yes / no / NULL |
| `b_cell` | INTEGER | Raw cell count |
| `cd8_t_cell` | INTEGER | Raw cell count |
| `cd4_t_cell` | INTEGER | Raw cell count |
| `nk_cell` | INTEGER | Raw cell count |
| `monocyte` | INTEGER | Raw cell count |

### Design Rationale

**Why three tables?**

Subject demographics (`condition`, `age`, `sex`) are stable facts about a person and do not change across samples. Storing them in a separate `subjects` table means this data is recorded once per patient rather than repeated in every sample row. This avoids update anomalies and keeps the data consistent.

The `projects` table acts as a lookup/registry for project IDs, enabling foreign key enforcement and making it straightforward to join project-level metadata (e.g. trial name, sponsor) if that information is added later.

**Scalability**

| Scenario | How the schema handles it |
|---|---|
| Hundreds of projects | `projects` table grows by one row per project; no schema change needed |
| Thousands of subjects per project | `subjects` rows scale independently; subject demographics are never duplicated |
| Multiple sample types per subject | Each sample is its own row in `samples`; `sample_type` distinguishes them |
| New cell populations | Requires an `ALTER TABLE` to add a column, or a redesign to a long-format `cell_counts` table (see below) |
| Diverse analytics (survival, drug combos) | Additional metadata tables (e.g. `treatments`, `outcomes`) can be added with FK relationships to `subjects` or `samples` |

**Trade-off: wide vs. long format for cell counts**

The current schema stores the five cell populations as columns in `samples` (wide format). This is simple, readable, and efficient for queries that always retrieve all five populations together.

An alternative is a separate `cell_counts(sample_id, population, count)` table (long format). This would make adding new populations trivial (just new rows) and enables cleaner aggregation queries, but at the cost of more complex joins for the most common query pattern. For a fixed, small set of five populations, the wide format is the pragmatic choice.

---

## Code Structure

```
teiko-takehome/
├── cell-count.csv       # Source data (provided)
├── teiko.db             # Generated by load_data.py
├── load_data.py         # Part 1: schema init + CSV loader
├── analysis.py          # Parts 2–4: all analysis logic
├── dashboard.py         # Streamlit interactive dashboard
├── requirements.txt     # Python dependencies
└── README.md
```

### `load_data.py`

Initializes the SQLite schema and loads `cell-count.csv` in a single pass. Uses `INSERT OR IGNORE` to make the script safely re-runnable (it deletes the existing `.db` first for a clean load). No external dependencies beyond the standard library.

### `analysis.py`

Contains all analytical logic, cleanly separated from the UI layer:

- **`get_frequency_table()`**: Queries all samples, computes per-population percentages, returns a long-format DataFrame (Part 2).
- **`get_timepoint_data(t)`**: Filters to melanoma + miraclib + PBMC samples at a single timepoint, computes per-sample cell frequencies, returns one row per subject. Used as the primary data source for Part 3 (called with `t=0`).
- **`run_statistical_tests(df)`**: Runs Mann-Whitney U (two-sided, non-parametric) per population comparing responders vs non-responders on any subject-level DataFrame. Returns raw p-values plus Bonferroni, BH FDR, and BY FDR corrections, and rank-biserial correlation effect sizes computed on post-dropna sample sizes. BY FDR is the primary correction; cell percentages are compositionally negatively correlated, violating BH's positive dependence assumption (Part 3).
- **`run_timepoint_sensitivity()`**: Repeats the Mann-Whitney U + BY FDR tests at each individual timepoint (t=0, t=7, t=14). Used to assess whether any signal is pre-existing at baseline or emerges only post-treatment (Part 3).
- **`get_boxplot_figure()`**: Returns a matplotlib figure for static use (Part 3).
- **`get_baseline_samples()`**: Queries the DB for melanoma PBMC baseline miraclib samples (Part 4).
- **`get_samples_per_project()`, `get_responder_counts()`, `get_sex_counts()`**: Aggregation helpers that operate on the baseline DataFrame (Part 4).
- **`get_avg_bcell_melanoma_males()`**: Returns the average B cell count for melanoma male responders at baseline.

### `dashboard.py`

A three-tab Streamlit app that calls functions from `analysis.py` and renders results with Plotly:

- **Tab 1 (Part 2):** Filterable frequency table with per-population summary statistics.
- **Tab 2 (Part 3):** Baseline (t=0) significance table + interactive boxplots annotated with p-value, BY FDR p-value, and effect size r. Below that, a temporal context section showing effect sizes and p-values across t=0, t=7, and t=14 to distinguish predictive signals from treatment-induced effects.
- **Tab 3 (Part 4):** Baseline sample counts broken down by project, response, and sex, plus average B cell count for melanoma male responders displayed as a metric.

Stable reference data (frequency table, baseline samples) is wrapped in `@st.cache_data`. Part 3 statistical results are computed fresh on each render to ensure formula and data changes are always reflected immediately.

**Why Streamlit?** It requires no frontend code, runs well in GitHub Codespaces (single port, no build step), and produces a shareable deployment URL via Streamlit Community Cloud with zero configuration.

---

## Key Findings

**Part 3: Statistical Analysis (melanoma, miraclib, PBMC):**

**Goal:** identify immune cell populations that predict treatment response *before* treatment starts.

**Unit of analysis:** one observation per subject at t=0 (single pre-treatment PBMC sample). Using only the baseline timepoint ensures the analysis is causally valid: only measurements taken before treatment can inform response prediction. All 656 subjects have a t=0 sample (331 responders, 325 non-responders).

**Test:** Mann-Whitney U (two-sided, non-parametric). Multiple testing correction applied across all 5 simultaneous comparisons. **Effect size:** rank-biserial correlation r, computed on post-dropna sample sizes (r > 0 = responders rank higher; r < 0 = non-responders rank higher). |r| < 0.1 negligible, 0.1–0.3 small.

**Correction note:** Cell population percentages are compositional (sum to 100%), inducing negative correlations between populations. BH FDR assumes independence or positive correlation and is therefore anti-conservative here. Benjamini-Yekutieli (BY) FDR is valid under any correlation structure and is used as the primary correction. Bonferroni (FWER) is included as a secondary check.

**Baseline (t=0) results:**

| Population | p (raw) | p (Bonferroni) | p (BY FDR) | Sig. (BY FDR) | Effect size r |
|---|---|---|---|---|---|
| b_cell | 0.5485 | 1.0000 | 1.0000 | No | +0.027 (negligible) |
| cd8_t_cell | 0.5140 | 1.0000 | 1.0000 | No | −0.030 (negligible) |
| cd4_t_cell | 0.7964 | 1.0000 | 1.0000 | No | +0.012 (negligible) |
| nk_cell | 0.8853 | 1.0000 | 1.0000 | No | −0.007 (negligible) |
| monocyte | 0.2114 | 1.0000 | 1.0000 | No | −0.056 (negligible) |

**Primary conclusion:** At baseline, no cell population distinguishes responders from non-responders. All raw p-values are well above 0.05 and all effect sizes are negligible (|r| < 0.06). There is no evidence of a pre-existing immune cell frequency signature that predicts miraclib response in this melanoma cohort.

**Temporal context: effect size r across timepoints:**

| Population | t=0 (baseline) | t=7 | t=14 |
|---|---|---|---|
| b_cell | +0.027 | −0.066 | −0.110 |
| cd4_t_cell | +0.012 | +0.098 | +0.080 |
| cd8_t_cell | −0.030 | −0.021 | +0.015 |
| monocyte | −0.056 | −0.032 | −0.021 |
| nk_cell | −0.007 | −0.067 | −0.045 |

**Key insight:** cd4_t_cell shows a near-zero effect at baseline (r = +0.012, p = 0.796) but a modest positive effect at t=7 (r = +0.098, raw p = 0.030) and t=14 (r = +0.080). This temporal pattern (signal absent pre-treatment, emerging post-treatment) indicates cd4_t_cell is a **marker of treatment response** (responders' CD4 T cell frequencies rise during treatment) rather than a predictor of who will respond. Neither the t=7 nor t=14 signal survives BY FDR correction. No population reaches significance at any timepoint after correction.

**Part 4: Baseline subset (melanoma, PBMC, time=0, miraclib):**

| Query | Result |
|---|---|
| Total baseline samples | 656 |
| Samples (prj1) | 384 |
| Samples (prj3) | 272 |
| Responders | 331 subjects |
| Non-responders | 325 subjects |
| Male | 344 subjects |
| Female | 312 subjects |

**Avg B cells (melanoma males, responders, time=0): `10401.28`**
