# Teiko technical: Immune Cell Population Analysis

An interactive clinical trial data analysis tool built with Python, SQLite, and Streamlit.

---

## Running in GitHub Codespaces

> All commands below work out of the box in a fresh GitHub Codespace.

### 1. Install dependencies

```bash
pip install -r requirements.txt
```

### 2. Initialize the database

```bash
python load_data.py
```

This loads `cell-count.csv` into a SQLite database (`teiko.db`) in the repo root. Output:

```
Initializing schema...
Loading data from cell-count.csv...
Done. Loaded into teiko.db:
  3 project(s)
  3500 subject(s)
  10500 sample(s)
```

### 3. Launch the dashboard (or just view it from the link below)

```bash
streamlit run dashboard.py
```

Streamlit will print a local URL (e.g. `http://localhost:8501`). In Codespaces, the port will be automatically forwarded and accessible via the **Ports** tab.

---

## Dashboard Link

[Launch Dashboard](https://zmt-cytometry.streamlit.app/)

---

## Database Schema

### Tables

#### `projects`
| Column | Type | Notes |
|--------|------|-------|
| `project_id` | TEXT | Primary key |

#### `subjects`
| Column | Type | Notes |
|--------|------|-------|
| `subject_id` | TEXT | Primary key |
| `project_id` | TEXT | Foreign key → `projects` |
| `condition` | TEXT | e.g. melanoma, carcinoma, healthy |
| `age` | INTEGER | |
| `sex` | TEXT | M / F |

#### `samples`
| Column | Type | Notes |
|--------|------|-------|
| `sample_id` | TEXT | Primary key |
| `subject_id` | TEXT | Foreign key → `subjects` |
| `sample_type` | TEXT | e.g. PBMC |
| `time_from_treatment_start` | INTEGER | Days since treatment start |
| `treatment` | TEXT | e.g. miraclib, phauximab, none |
| `response` | TEXT | yes / no / NULL |
| `b_cell` | INTEGER | Raw cell count |
| `cd8_t_cell` | INTEGER | Raw cell count |
| `cd4_t_cell` | INTEGER | Raw cell count |
| `nk_cell` | INTEGER | Raw cell count |
| `monocyte` | INTEGER | Raw cell count |

### Design Rationale

**Why three tables?**

Subject demographics (`condition`, `age`, `sex`) are stable facts about a person and do not change across samples. Storing them in a separate `subjects` table means this data is recorded once per patient rather than repeated in every sample row. This avoids update anomalies and keeps the data consistent.

The `projects` table acts as a lookup/registry for project IDs, enabling foreign key enforcement and making it straightforward to join project-level metadata (e.g. trial name, sponsor) if that information is added later.

**Scalability**

| Scenario | How the schema handles it |
|---|---|
| Hundreds of projects | `projects` table grows by one row per project; no schema change needed |
| Thousands of subjects per project | `subjects` rows scale independently; subject demographics are never duplicated |
| Multiple sample types per subject | Each sample is its own row in `samples`; `sample_type` distinguishes them |
| New cell populations | Requires an `ALTER TABLE` to add a column, or a redesign to a long-format `cell_counts` table (see below) |
| Diverse analytics (survival, drug combos) | Additional metadata tables (e.g. `treatments`, `outcomes`) can be added with FK relationships to `subjects` or `samples` |

**Trade-off: wide vs. long format for cell counts**

The current schema stores the five cell populations as columns in `samples` (wide format). This is simple, readable, and efficient for queries that always retrieve all five populations together.

An alternative is a separate `cell_counts(sample_id, population, count)` table (long format). This would make adding new populations trivial (just new rows) and enables cleaner aggregation queries, but at the cost of more complex joins for the most common query pattern. For a fixed, small set of five populations, the wide format is the pragmatic choice.

---

## Code Structure

```
teiko-takehome/
├── cell-count.csv       # Source data (provided)
├── teiko.db             # Generated by load_data.py
├── load_data.py         # Part 1: schema init + CSV loader
├── analysis.py          # Parts 2–4: all analysis logic
├── dashboard.py         # Streamlit interactive dashboard
├── requirements.txt     # Python dependencies
└── README.md
```

### `load_data.py`

Initializes the SQLite schema and loads `cell-count.csv` in a single pass. Uses `INSERT OR IGNORE` to make the script safely re-runnable (it deletes the existing `.db` first for a clean load). No external dependencies beyond the standard library.

### `analysis.py`

Contains all analytical logic, cleanly separated from the UI layer:

- **`get_frequency_table()`**: Queries all samples, computes per-population percentages, returns a long-format DataFrame (Part 2).
- **`get_timepoint_data(t)`**: Filters to melanoma + miraclib + PBMC samples at a single timepoint, computes per-sample cell frequencies, returns one row per subject (Part 3).
- **`run_statistical_tests(df)`**: Runs Mann-Whitney U (two-sided, non-parametric) per population comparing responders vs non-responders. Returns raw p-values plus Bonferroni, BH FDR, and BY FDR corrections, and rank-biserial correlation effect sizes. BY FDR is the reported correction; cell percentages are compositionally negatively correlated, violating BH's positive-dependence assumption (Part 3).
- **`run_timepoint_sensitivity()`**: Repeats Mann-Whitney U + BY FDR at each timepoint (t=0, t=7, t=14) to show how effect sizes evolve over the course of treatment (Part 3).
- **`get_longitudinal_data()`**: Returns all three timepoints combined for the filtered cohort, one row per (subject, timepoint). Used as input for trajectory analysis (Part 3).
- **`run_mixed_effects_models(long_df)`**: Fits a linear mixed effects model per population (`frequency ~ time * response + (1 | subject)`). The time x response interaction term tests whether trajectories diverge between groups while accounting for repeated measures within subjects (Part 3).
- **`run_mixed_effects_models_clr(long_df)`**: Sensitivity analysis - same LMM on CLR-transformed frequencies (`CLR(x) = log(x) - mean(log(x))` per sample). Removes the constant-sum constraint of compositional data, giving an unconstrained outcome that better satisfies linear model assumptions (Part 3).
- **`get_boxplot_figure()`**: Returns a matplotlib figure for static use (Part 3).
- **`get_baseline_samples()`**: Queries the DB for melanoma PBMC baseline miraclib samples (Part 4).
- **`get_samples_per_project()`, `get_responder_counts()`, `get_sex_counts()`**: Aggregation helpers that operate on the baseline DataFrame (Part 4).
- **`get_avg_bcell_melanoma_males()`**: Returns the average B cell count for melanoma male responders at baseline (Part 4).

### `dashboard.py`

A three-tab Streamlit app that calls functions from `analysis.py` and renders results with Plotly:

- **Tab 1 (Part 2):** Filterable frequency table with per-population summary statistics.
- **Tab 2 (Part 3):** Two-section layout telling a coherent story about immune cell frequencies and treatment response.
  - *Before Treatment:* Significance table (t=0) + interactive boxplots with a timepoint selector (t=0 labeled as prediction-relevant). Answers whether any population predicts response before treatment starts.
  - *During Treatment:* Mean trajectory line plots (+/- 95% CI) across t=0, t=7, t=14 for all five populations, plus a mixed effects model table testing whether trajectories diverge between groups. Answers whether any population changes differently over the course of treatment.
  - Per-timepoint effect size and p-value tables are available in a collapsed expander.
  - A CLR sensitivity analysis expander shows the same LMM on centered log-ratio transformed frequencies, confirming the null conclusion holds on the compositionally-corrected scale.
- **Tab 3 (Part 4):** Baseline sample counts broken down by project, response, and sex, plus average B cell count for melanoma male responders displayed as a metric.

Stable reference data (frequency table, baseline samples, longitudinal data) is wrapped in `@st.cache_data`. Statistical results are computed fresh on each render.

**Why Streamlit?** It requires no frontend code, runs well in GitHub Codespaces (single port, no build step), and produces a shareable deployment URL via Streamlit Community Cloud with zero configuration.

---

## Key Findings

**Part 3: Statistical Analysis (melanoma, miraclib, PBMC, n = 656)**

### Before treatment: can baseline frequencies predict who will respond?

**Short answer: no.** None of the five populations tested distinguishes responders from non-responders before treatment starts.

| Population | p (raw) | p (BY FDR) | Effect size r |
|---|---|---|---|
| b_cell | 0.5485 | 1.0000 | +0.027 (negligible) |
| cd8_t_cell | 0.5140 | 1.0000 | -0.030 (negligible) |
| cd4_t_cell | 0.7964 | 1.0000 | +0.012 (negligible) |
| nk_cell | 0.8853 | 1.0000 | -0.007 (negligible) |
| monocyte | 0.2114 | 1.0000 | -0.056 (negligible) |

All raw p-values exceed 0.20. All effect sizes are negligible (|r| < 0.06). There is no pre-treatment immune cell frequency signature that predicts miraclib response in this cohort.

*Correction note:* BY FDR is used rather than BH FDR because cell percentages sum to 100%, inducing negative correlations between populations that violate BH's positive-dependence assumption.

### During treatment: do any populations change differently over time?

A linear mixed effects model (`frequency ~ time * response + (1 | subject)`) was fit per population to test whether trajectories diverge between groups across t=0, t=7, and t=14.

BY FDR correction applied across the 5 simultaneous interaction tests, consistent with the Mann-Whitney analysis.

| Population | p (time x response, raw) | p (time x response, BY FDR) | Significant? |
|---|---|---|---|
| b_cell | 0.0156 | 0.1781 | No |
| cd8_t_cell | 0.5837 | 1.0000 | No |
| cd4_t_cell | 0.2883 | 1.0000 | No |
| nk_cell | 0.4066 | 1.0000 | No |
| monocyte | 0.4648 | 1.0000 | No |

**No population shows a significant trajectory difference after BY FDR correction.** B cells have the smallest raw interaction p-value (0.016) and their trajectories visually diverge in the line plot (responders decline, non-responders remain stable), but this does not survive correction for 5 simultaneous tests (BY FDR p = 0.178). The pattern is a candidate for follow-up but cannot be claimed as a statistically significant finding with this dataset.

**Part 4: Baseline subset (melanoma, PBMC, time=0, miraclib):**

| Query | Result |
|---|---|
| Total baseline samples | 656 |
| Samples (prj1) | 384 |
| Samples (prj3) | 272 |
| Responders | 331 subjects |
| Non-responders | 325 subjects |
| Male | 344 subjects |
| Female | 312 subjects |

**Avg B cells (melanoma males, responders, time=0): `10401.28`**
